import{j as e}from"./ui-5CGx59HE.js";import{r as t}from"./vendor-Ce2S7JN_.js";import{u as s,B as n}from"./index-DXJv48IP.js";import{s as r}from"./client-ClhMjqWB.js";import{L as a}from"./loader-circle-Cz5GAv8d.js";import{S as i}from"./shield-2CMa0t69.js";import{C as c}from"./circle-check-big-CBL_LzJM.js";import{C as o}from"./circle-alert-BSl6uMxW.js";import{C as l}from"./clock-Bsx_Ypxj.js";const d=()=>{const[d,u]=t.useState(!1),[m,g]=t.useState(null),[h,y]=t.useState(""),[f,p]=t.useState(!1),[x,w]=t.useState(null),[b,j]=t.useState(!1),{toast:v}=s();t.useEffect(()=>{S();const e=r.channel("sync-status").on("postgres_changes",{event:"*",schema:"public",table:"sync_status",filter:"id=eq.cars-sync-main"},e=>{e.new&&(g(e.new),E(e.new))}).subscribe();return()=>{e.unsubscribe()}},[]);const S=async()=>{try{const[e,t,s]=await Promise.all([r.from("sync_status").select("*").eq("id","cars-sync-main").single(),r.from("cars_cache").select("*",{count:"exact",head:!0}),r.from("cars").select("*",{count:"exact",head:!0})]);if(e.error&&"PGRST116"!==e.error.code)return;if(e.data){const n=N(e.data);if(p(n),n&&"running"===e.data.status)return void(await _());const r=t.count||0,a=s.count||0,i=r>0?r:a;let c=e.data.records_processed||0;const o=n||"failed"===e.data.status||"completed"===e.data.status;(0===c&&i>0||o&&i>c||i>0&&i>10*c)&&(c=i);const l={...e.data,records_processed:c};g(l),E(l),"running"===l.status?u(!0):u(!1)}}catch(e){}},N=e=>{if("running"!==e.status)return!1;const t=e.last_activity_at?new Date(e.last_activity_at):new Date(e.started_at||0),s=Date.now(),n=s-t.getTime(),r=s-(e.started_at?new Date(e.started_at):new Date(0)).getTime();return n>6e5||r>72e5},_=async()=>{try{const{error:e}=await r.from("sync_status").update({status:"failed",error_message:"Auto-cleaned: Sync was stuck for more than 10 minutes without activity or running too long",completed_at:(new Date).toISOString(),last_activity_at:(new Date).toISOString()}).eq("id","cars-sync-main");if(e)throw e;u(!1),p(!1),v({title:"🔧 Stuck Sync Cleaned Up",description:"The stuck sync has been automatically cleaned up. You can now start a new sync."}),setTimeout(S,2e3)}catch(e){v({title:"⚠️ Cleanup Failed",description:"Failed to clean up stuck sync. Please try manually stopping the sync.",variant:"destructive"})}},E=e=>{if(!e)return;const t=e.records_processed||0,s=192800,n=Math.round(t/s*100),r=t.toLocaleString(),a=s.toLocaleString();let i="";if(e.error_message&&e.error_message.includes("Rate:")){const t=e.error_message.match(/Rate: (\d+) cars\/min/);t&&(i=` (${t[1]} cars/min)`)}switch(e.status){case"running":const s=e.started_at?Math.round((Date.now()-new Date(e.started_at).getTime())/6e4):0;t>=Math.floor(188944)?y(`🎯 Nearly complete! ${r} / ${a} cars (${n}%) - Final processing...`):y(`🔄 Syncing${i}... ${r} / ${a} cars (${n}%) - Running for ${s}min`);break;case"completed":y(`✅ Sync complete! ${r} cars synced successfully`),setTimeout(()=>k(),2e3);break;case"failed":const c=e.error_message?` (${e.error_message.substring(0,50)}...)`:"";y(`❌ Sync failed at ${r} cars${c}. Will auto-resume.`);break;case"paused":y(`🔄 Syncing${i}... ${r} / ${a} cars (${n}%) - Resuming automatically`);break;default:y(`📊 Status: ${e.status} - ${r} cars processed`)}},k=async()=>{j(!0),w(null);try{v({title:"Verifying Sync",description:"Checking if data was properly synced to database..."});const e=await async function(e,t={}){const{verifyRecordCount:s=!0,verifySampleRecords:n=!0,verifyDataIntegrity:a=!0,verifyTimestamps:i=!0,sampleSize:c=10,syncTimeThresholdHours:o=72,dataIntegrityThresholdPercent:l=20,queryTimeoutMs:d=1e4}=t,u=[],m={};try{if(s){const{count:e,error:t}=await r.from("cars").select("*",{count:"exact",head:!0});t?u.push(`Failed to count records in cars table: ${t.message}`):m.actualCount=e||0}const{count:e,error:t}=await r.from("cars_staging").select("*",{count:"exact",head:!0});if(t?u.push(`Failed to check staging table: ${t.message}`):(m.stagingTableCleared=0===e,e>0&&u.push(`Staging table not cleared: ${e} records remaining`)),i){const{data:e,error:t}=await r.from("cars").select("last_synced_at").order("last_synced_at",{ascending:!1}).limit(100);if(t)u.push(`Failed to check sync timestamps: ${t.message}`);else if(e&&e.length>0){const t=e[0].last_synced_at;m.lastSyncTime=t;const s=new Date(t),n=((new Date).getTime()-s.getTime())/36e5;n>o&&u.push(`Last sync is too old: ${n.toFixed(1)} hours ago (threshold: ${o} hours)`)}}if(n&&m.actualCount&&m.actualCount>0){const{data:e,error:t}=await r.from("cars").select("id, make, model, year, price, external_id, source_api, last_synced_at").limit(c);if(t)u.push(`Failed to fetch sample records: ${t.message}`);else if(e){let t=0;for(const s of e){const e=s.id&&"string"==typeof s.id&&s.id.trim().length>0,n=s.make&&"string"==typeof s.make&&s.make.trim().length>0,r=s.model&&"string"==typeof s.model&&s.model.trim().length>0,a=s.external_id&&"string"==typeof s.external_id&&s.external_id.trim().length>0;if(e&&n&&r&&a)t++;else{const t=[];e||t.push("id"),n||t.push("make"),r||t.push("model"),a||t.push("external_id")}}m.sampleRecordsVerified=t===e.length,t<e.length&&u.push(`Sample verification failed: ${t}/${e.length} records valid`)}}if(a){const{data:e,error:t}=await r.from("cars_cache").select("*",{count:"exact",head:!0});if(t)m.dataIntegrityPassed=!0;else{const t=e||0,s=m.actualCount||0;if(0===t)m.dataIntegrityPassed=!0;else{const e=Math.abs(s-Number(t)),n=s>0?e/s*100:0;m.dataIntegrityPassed=n<l,n>=l&&u.push(`Data integrity issue: ${n.toFixed(1)}% difference between main (${s}) and cache (${t}) tables (threshold: ${l}%)`)}}}try{const{data:e,error:t}=await Promise.race([r.from("sync_status").select("status, error_message, started_at").order("started_at",{ascending:!1}).limit(1).single(),new Promise((e,t)=>setTimeout(()=>t(new Error("Sync status query timeout")),d))]);t&&"PGRST116"!==t.code?t.message?.includes("timeout")||t.message?.includes("canceling statement")||u.push(`Failed to check sync status: ${t.message}`):e&&("failed"===e.status?u.push(`Last sync failed: ${e.error_message||"Unknown error"}`):e.status)}catch(g){(g instanceof Error?g.message:"Unknown timeout error").includes("timeout")}const h=0===u.length,y=h?"✅ Sync verification completed successfully - database is properly synced":`❌ Sync verification failed with ${u.length} issues`;return u.length,{success:h,message:y,details:m,errors:u.length>0?u:void 0}}catch(h){const e=h instanceof Error?h.message:"Unknown error";return{success:!1,message:`Sync verification failed: ${e}`,details:m,errors:[e]}}}();w(e),e.success?v({title:"✅ Sync Verification Passed",description:`Database sync confirmed! ${e.details.actualCount||0} records verified.`}):v({title:"❌ Sync Verification Failed",description:e.message,variant:"destructive"})}catch(e){const t=e instanceof Error?e.message:"Unknown error";w({success:!1,message:`Verification failed: ${t}`,details:{},errors:[t]}),v({title:"❌ Verification Error",description:t,variant:"destructive"})}finally{j(!1)}},C=async()=>{u(!0),y("Initiating AI-powered bulletproof sync...");try{v({title:"🚀 AI-POWERED BULLETPROOF SYNC STARTING!",description:"Advanced AI coordination with infinite retry capabilities and intelligent error recovery!"});const e=window.aiSyncCoordinator;e?await e.startIntelligentSync({source:"manual-smart-sync"}):await T(),v({title:"🚀 AI-POWERED SYNC LAUNCHED!",description:"Bulletproof sync running with AI coordination. Zero-failure guarantee!"}),y("AI-powered sync started in background...");const t=setInterval(async()=>{await S(),"completed"!==m?.status&&"failed"!==m?.status||(clearInterval(t),u(!1),"completed"===m?.status?(v({title:"🎉 100% SYNC COMPLETE!",description:"All cars synchronized successfully! Page will refresh in 2 seconds."}),setTimeout(()=>{window.location.reload()},2e3)):"failed"===m?.status&&setTimeout(()=>C(),3e3))},5e3)}catch(e){y("Smart sync failed. AI auto-recovery will retry..."),u(!1);let t="Failed to start smart sync. AI will auto-retry.",s="Sync Failed - Auto-Retry Scheduled";e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message&&(t=e.message,e.message.includes("Configuration error")?(s="Configuration Error - Admin Intervention Required",t+=" Please contact administrator."):e.message.includes("Authentication failed")?(s="Authentication Error - Admin Intervention Required",t+=" Please contact administrator."):e.message.includes("Network error")?(s="Network Error - Auto-Retry in Progress",t+=" AI will retry when network recovers."):e.message.includes("timeout")?(s="Timeout Error - Auto-Retry Scheduled",t+=" AI will retry with longer timeout."):e.message.includes("Server error")&&(s="Server Error - Auto-Retry When Available",t+=" AI will retry when server recovers.")),v({title:s,description:t,variant:"destructive"}),t.includes("Configuration")||t.includes("Authentication")||setTimeout(()=>C(),1e4)}},T=async(e=1,t=3)=>{try{const{data:t,error:s}=await r.functions.invoke("cars-sync",{body:{smartSync:!0,source:"enhanced-manual",attempt:e}});if(s){if(s.message?.includes("already running")||"running"===t?.status)return void v({title:"Sync Already Running",description:"A sync is already in progress. Monitor progress below."});throw s}if(!t?.success)throw new Error(t?.error||"Unknown error occurred")}catch(s){if(e<t){const s=2e3*Math.pow(2,e);return await new Promise(e=>setTimeout(e,s)),T(e+1,t)}throw s}},F=!d&&(!m||["completed","failed","idle"].includes(m.status)),I="running"===m?.status&&(f||m.current_page>0),A=()=>{if(!m||!m.records_processed)return 0;const e=m.records_processed;return Math.min(100,e/192800*100)},P=()=>{if(!m||"running"!==m.status||!m.records_processed)return"Calculating...";let e=0;if(m.error_message&&m.error_message.includes("Rate:")){const t=m.error_message.match(/Rate: (\d+) cars\/min/);t&&(e=parseInt(t[1]))}if(0===e){const t=new Date(m.started_at).getTime(),s=Date.now()-t;e=Math.round(m.records_processed/s*6e4)}if(e<=0)return"Calculating...";const t=192800-m.records_processed,s=Math.ceil(t/e);if(s<=0)return"Almost done...";const n=Math.floor(s/60),r=s%60;return n>0?`~${n}h ${r}m remaining`:`~${r}m remaining`},R="running"===m?.status,D="completed"===m?.status;return e.jsxs("div",{className:"p-6 border rounded-lg bg-card space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[(()=>{if(!m)return e.jsx(l,{className:"h-4 w-4"});switch(m.status){case"running":return e.jsx(a,{className:"h-4 w-4 animate-spin"});case"completed":return e.jsx(c,{className:"h-4 w-4 text-green-500"});case"failed":return e.jsx(o,{className:"h-4 w-4 text-red-500"});default:return e.jsx(l,{className:"h-4 w-4"})}})(),e.jsx("h3",{className:"text-lg font-semibold",children:"Smart Cars Sync System"})]}),m&&e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold text-primary",children:m.records_processed?.toLocaleString()||0}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"cars synced"})]}),R&&e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-semibold text-blue-600",children:P()}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"ETA"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-semibold text-emerald-600",children:[A().toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"complete"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-muted-foreground",children:["🚀 ",e.jsx("strong",{children:"CONTINUOUS SYNC SYSTEM:"})," Processes 3 pages simultaneously with 50-car database batches. Features bulletproof error handling with 20 retries per request and 100 rate-limit retries. NEVER PAUSES OR STOPS until 100% complete - handles any API issue automatically and continues indefinitely!"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{children:e.jsx("strong",{children:"🔥 Speed Features:"})}),e.jsxs("ul",{className:"list-disc list-inside space-y-0.5 text-muted-foreground",children:[e.jsx("li",{children:"3x parallel page processing"}),e.jsx("li",{children:"50-car batch database writes"}),e.jsx("li",{children:"Minimal 10ms delays"}),e.jsx("li",{children:"45-second request timeouts"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{children:e.jsx("strong",{children:"🛡️ Bulletproof Features:"})}),e.jsxs("ul",{className:"list-disc list-inside space-y-0.5 text-muted-foreground",children:[e.jsx("li",{children:"20 retries per failed request"}),e.jsx("li",{children:"100 rate-limit retry attempts"}),e.jsx("li",{children:"Smart adaptive delays"}),e.jsx("li",{children:"Never pauses or stops until 100% complete"})]})]})]})]}),m&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:"Sync Progress"}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-bold",children:[m.records_processed?.toLocaleString()||0," cars"]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[A().toFixed(1),"% complete"]})]})]}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"w-full bg-muted rounded-full h-4 overflow-hidden shadow-inner",children:[e.jsx("div",{className:"h-4 rounded-full transition-all duration-700 ease-out relative "+(R?"bg-gradient-to-r from-blue-500 to-blue-600":D?"bg-gradient-to-r from-green-500 to-green-600":"failed"===m.status?"bg-gradient-to-r from-red-500 to-red-600":"bg-gradient-to-r from-yellow-500 to-yellow-600"),style:{width:`${Math.max(2,A())}%`},children:R&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent",style:{backgroundImage:"repeating-linear-gradient(45deg, transparent, transparent 8px, rgba(255,255,255,0.2) 8px, rgba(255,255,255,0.2) 16px)",animation:"slide 1.5s linear infinite"}})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("span",{className:"text-xs font-bold text-white drop-shadow-md",children:A()>8?`${A().toFixed(1)}%`:""})})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-xs bg-muted/50 p-3 rounded",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Current Page:"}),e.jsx("span",{className:"font-medium",children:m.current_page?.toLocaleString()||0})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsxs("span",{className:"font-medium capitalize "+(D?"text-green-600":R?"text-blue-600":"failed"===m.status?"text-red-600":"text-yellow-600"),children:[m.status,R&&e.jsx("span",{className:"ml-1 animate-pulse",children:"●"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Target:"}),e.jsx("span",{className:"font-medium",children:"192,800 cars"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"ETA:"}),e.jsx("span",{className:"font-medium",children:P()})]})]}),m.error_message&&m.error_message.includes("Rate:")&&e.jsxs("div",{className:"col-span-2 pt-2 border-t text-xs text-muted-foreground",children:[e.jsx("div",{className:"font-medium text-primary",children:"Performance Metrics:"}),e.jsx("div",{className:"mt-1",children:m.error_message})]})]})]}),e.jsxs("div",{className:"text-sm space-y-1 border-t pt-3",children:[m.started_at&&e.jsxs("p",{children:[e.jsx("strong",{children:"Started:"})," ",new Date(m.started_at).toLocaleString()]}),m.completed_at&&e.jsxs("p",{children:[e.jsx("strong",{children:"Completed:"})," ",new Date(m.completed_at).toLocaleString()]}),m.last_activity_at&&R&&e.jsxs("p",{children:[e.jsx("strong",{children:"Last Activity:"})," ",new Date(m.last_activity_at).toLocaleString()]})]})]}),h&&e.jsx("div",{className:"p-3 bg-muted rounded text-sm",children:e.jsx("p",{children:h})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{onClick:C,disabled:!F,className:"flex-1",children:d?e.jsxs(e.Fragment,{children:[e.jsx(a,{className:"mr-2 h-4 w-4 animate-spin"}),"Syncing..."]}):"🚀 Start MAXIMUM SPEED Sync"}),I&&e.jsx(n,{onClick:async()=>{try{v({title:"Force Stopping Sync",description:"Manually stopping the current sync..."});const{error:e}=await r.from("sync_status").update({status:"failed",error_message:"Manually stopped by admin",completed_at:(new Date).toISOString()}).eq("id","cars-sync-main");if(e)throw e;u(!1),p(!1),v({title:"Sync Stopped",description:"Sync has been manually stopped. You can start a new sync now."}),setTimeout(S,1e3)}catch(e){v({title:"Force Stop Failed",description:e.message||"Failed to force stop sync.",variant:"destructive"})}},variant:"destructive",className:"flex-1",children:f?"Fix Stuck Sync":"Force Stop"}),e.jsx(n,{onClick:k,disabled:b,variant:"outline",className:"flex items-center gap-2",children:b?e.jsxs(e.Fragment,{children:[e.jsx(a,{className:"h-4 w-4 animate-spin"}),"Verifying..."]}):e.jsxs(e.Fragment,{children:[e.jsx(i,{className:"h-4 w-4"}),"Verify DB"]})}),m&&m.records_processed&&m.records_processed<1e3&&e.jsx(n,{onClick:async()=>{try{const{error:e}=await r.from("sync_status").update({status:"failed",error_message:"Manually reset by user - sync was showing incorrect count",completed_at:(new Date).toISOString(),last_activity_at:(new Date).toISOString()}).eq("id","cars-sync-main");if(e)throw e;u(!1),p(!1),v({title:"🔄 Sync Reset",description:"Sync status has been manually reset. The display will now show the correct car count."}),setTimeout(S,1e3)}catch(e){v({title:"⚠️ Reset Failed",description:"Failed to reset sync status. Please try again.",variant:"destructive"})}},variant:"outline",className:"flex items-center gap-2 text-orange-600 border-orange-200 hover:bg-orange-50",title:"Reset sync status if showing incorrect car count",children:"🔄 Reset Count"})]}),x&&e.jsxs("div",{className:"mt-4 p-4 rounded-lg border "+(x.success?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[x.success?e.jsx(c,{className:"h-5 w-5 text-green-600"}):e.jsx(o,{className:"h-5 w-5 text-red-600"}),e.jsxs("h4",{className:"font-semibold "+(x.success?"text-green-800":"text-red-800"),children:["Sync Verification ",x.success?"Passed":"Failed"]})]}),e.jsx("p",{className:"text-sm mb-3 "+(x.success?"text-green-700":"text-red-700"),children:x.message}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium mb-1",children:"Database Status:"}),e.jsxs("ul",{className:"space-y-1 text-muted-foreground",children:[void 0!==x.details.actualCount&&e.jsxs("li",{children:["• Records in DB: ",x.details.actualCount.toLocaleString()]}),void 0!==x.details.stagingTableCleared&&e.jsxs("li",{className:x.details.stagingTableCleared?"text-green-600":"text-red-600",children:["• Staging cleanup: ",x.details.stagingTableCleared?"Success":"Failed"]}),x.details.lastSyncTime&&e.jsxs("li",{children:["• Last sync: ",new Date(x.details.lastSyncTime).toLocaleString()]})]})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium mb-1",children:"Integrity Checks:"}),e.jsxs("ul",{className:"space-y-1 text-muted-foreground",children:[void 0!==x.details.sampleRecordsVerified&&e.jsxs("li",{className:x.details.sampleRecordsVerified?"text-green-600":"text-red-600",children:["• Sample records: ",x.details.sampleRecordsVerified?"Valid":"Issues found"]}),void 0!==x.details.dataIntegrityPassed&&e.jsxs("li",{className:x.details.dataIntegrityPassed?"text-green-600":"text-red-600",children:["• Data integrity: ",x.details.dataIntegrityPassed?"Passed":"Failed"]})]})]})]}),x.errors&&x.errors.length>0&&e.jsxs("div",{className:"mt-3 p-2 bg-red-100 rounded border",children:[e.jsx("h5",{className:"font-medium text-red-800 mb-1",children:"Issues Found:"}),e.jsx("ul",{className:"text-sm text-red-700 space-y-1",children:x.errors.map((t,s)=>e.jsxs("li",{children:["• ",t]},s))})]})]}),f&&e.jsx("div",{className:"mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm",children:e.jsxs("p",{className:"text-yellow-800",children:["⚠️ ",e.jsx("strong",{children:"Stuck Sync Detected:"}),' The sync has been inactive for more than 20 minutes. It may have timed out or encountered an issue. Click "Fix Stuck Sync" to reset and try again.']})}),e.jsxs("div",{className:"mt-4 p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"🔄 Enhanced Smart Sync Features"}),e.jsxs("ul",{className:"text-sm space-y-1 text-muted-foreground",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"🚀 MAXIMUM SPEED:"})," No artificial delays, 250-item pages, 750-item batches"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"🛡️ BULLETPROOF:"})," 30+ retries per request, instant error recovery"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"⚡ NEVER PAUSES:"})," Zero delays between operations - runs at full throttle"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"📊 REAL-TIME:"})," Live progress with speed metrics every few seconds"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"🎯 SMART RESUME:"})," Immediate auto-recovery from any interruption (no manual intervention)"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"🔧 FORCE OVERRIDE:"})," Manual controls for stuck syncs (improved 20min detection)"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"🤖 AUTO-SCHEDULER:"})," Background recovery system active 24/7"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"📈 ACCURATE COUNTS:"})," Real-time counting from multiple data sources"]})]})]}),m&&e.jsxs("div",{className:"mt-4 p-4 bg-slate-50 rounded-lg border",children:[e.jsx("h4",{className:"font-semibold mb-2 text-slate-700",children:"🔍 Debug Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium mb-1 text-slate-600",children:"Sync Status:"}),e.jsxs("ul",{className:"space-y-1 text-slate-600",children:[e.jsxs("li",{children:["• Status: ",e.jsx("span",{className:"font-mono",children:m.status})]}),e.jsxs("li",{children:["• Current Page: ",e.jsx("span",{className:"font-mono",children:m.current_page||0})]}),e.jsxs("li",{children:["• Records: ",e.jsx("span",{className:"font-mono",children:m.records_processed||0})]}),m.last_activity_at&&e.jsxs("li",{children:["• Last Activity: ",e.jsx("span",{className:"font-mono",children:new Date(m.last_activity_at).toLocaleTimeString()})]})]})]}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium mb-1 text-slate-600",children:"System Health:"}),e.jsxs("ul",{className:"space-y-1 text-slate-600",children:[e.jsxs("li",{children:["• Stuck Detection: ",e.jsx("span",{className:"font-mono "+(f?"text-red-600":"text-green-600"),children:f?"STUCK":"OK"})]}),e.jsxs("li",{children:["• Auto-Cleanup: ",e.jsx("span",{className:"font-mono text-green-600",children:"ENABLED"})]}),e.jsxs("li",{children:["• Threshold: ",e.jsx("span",{className:"font-mono",children:"20 minutes"})]}),e.jsxs("li",{children:["• Real-time Updates: ",e.jsx("span",{className:"font-mono text-green-600",children:"ACTIVE"})]})]})]})]})]})]})},u=({enabled:e=!0,checkIntervalMinutes:s=.5}={})=>(t.useEffect(()=>{if(!e)return;const t=async()=>{try{const{data:t}=await r.from("sync_status").select("*").in("status",["failed"]).gte("records_processed",0).order("last_activity_at",{ascending:!1}).limit(1);if(t&&t.length>0){const s=t[0];if(Date.now()-new Date(s.completed_at||s.last_activity_at).getTime()>5e3){const t=window.aiSyncCoordinator;if(t)try{await t.startIntelligentSync({resume:!0,fromPage:s.current_page,reconcileProgress:!0,source:"immediate-auto-resume"})}catch(e){await n(s)}else await n(s)}}const{data:s}=await r.from("sync_status").select("*").eq("status","running").lt("last_activity_at",new Date(Date.now()-18e4).toISOString());if(s&&s.length>0)for(const e of s)await r.from("sync_status").update({status:"failed",error_message:"Auto-detected: Sync was stuck with no activity for 5+ minutes - will auto-resume immediately",completed_at:(new Date).toISOString()}).eq("id",e.id)}catch(e){}},n=async(e,t=1,s=3)=>{try{const{data:s,error:n}=await r.functions.invoke("cars-sync",{body:{smartSync:!0,resume:!0,fromPage:e.current_page,reconcileProgress:!0,source:"immediate-auto-resume-fallback",attempt:t}});if(n)throw n}catch(a){if(t<s){const r=1e3*Math.pow(2,t);setTimeout(()=>n(e,t+1,s),r)}}};t();const a=setInterval(t,60*s*1e3);return()=>{clearInterval(a)}},[e,s]),null),m=({enabled:e=!0,maxRetries:n=8,retryDelayMs:a=1e3}={})=>{const[i,c]=t.useState(!1),[o,l]=t.useState(0),{toast:d}=s(),u=t.useCallback(e=>{const t=e&&"object"==typeof e&&"message"in e?String(e.message):String(e)||"Unknown error";return t.includes("timed out")&&t.includes("function may not be deployed")||t.includes("edge function may not be deployed")||t.includes("Connection test timed out")||t.includes("Edge Function not accessible")&&(t.includes("Connection")||t.includes("timed out")||t.includes("Unknown connectivity")||t.includes("Network error")||t.includes("Request aborted")||t.match(/Edge Function not accessible:\s*$/)||t.includes("Unknown connectivity issue"))?{category:"deployment",recoverable:!1,delayMs:0,action:"abort"}:t.includes("Failed to send")||t.includes("fetch failed")||t.includes("ENOTFOUND")||t.includes("AbortError")?{category:"network",recoverable:!0,delayMs:3e3,action:"retry"}:t.includes("Edge Function")&&!t.includes("Failed to send")||t.includes("Deno")||t.includes("Function Error")?{category:"edge_function",recoverable:!0,delayMs:5e3,action:"retry"}:t.includes("timeout")&&!t.includes("deployed")?{category:"timeout",recoverable:!0,delayMs:5e3,action:"retry"}:t.includes("network")&&!t.includes("Failed to send")?{category:"network",recoverable:!0,delayMs:3e3,action:"retry"}:t.includes("Authentication")||t.includes("401")||t.includes("Unauthorized")?{category:"auth",recoverable:!1,delayMs:0,action:"abort"}:t.includes("HTTP 5")||t.includes("Server error")||t.includes("Internal Server Error")?{category:"server",recoverable:!0,delayMs:8e3,action:"retry"}:t.includes("Configuration")||t.includes("environment variables")||t.includes("Missing required")?{category:"config",recoverable:!1,delayMs:0,action:"abort"}:{category:"network",recoverable:!0,delayMs:a,action:"retry"}},[a]),m=t.useCallback(async()=>{try{const e=new Promise((e,t)=>{setTimeout(()=>t(new Error("Connection test timed out after 10 seconds - edge function may not be deployed")),1e4)}),t=r.functions.invoke("cars-sync",{body:{test:!0,source:"connectivity-test"},headers:{"x-test":"connectivity"}}),{data:s,error:n}=await Promise.race([t,e]);if(n){const e=(n instanceof Error?n.message:String(n))||"Unknown edge function error";let t=e;return e.includes("fetch")&&e.includes("failed")?t="Failed to send request to edge function - network or deployment issue":e.includes("404")||e.includes("not found")?t="Edge function not found - cars-sync function is not deployed":(e.includes("401")||e.includes("403"))&&(t="Authentication error - check API key configuration"),{connected:!1,error:t,details:`Edge function returned error: ${JSON.stringify(n)}`}}return{connected:!0,details:`Edge function responded successfully: ${JSON.stringify(s)}`}}catch(e){const t=e instanceof Error?e.message:String(e);let s=t,n=`Failed to connect to edge function: ${t}`;return t.includes("timed out")?(s="Connection timed out - edge function may not be deployed or is unresponsive",n="The cars-sync edge function is either not deployed to Supabase or is not responding. Check the Supabase dashboard to ensure the function is deployed and configured correctly."):t.includes("fetch")||t.includes("network")?(s="Network error - unable to reach edge function endpoint",n="Could not establish connection to the edge function. This may be due to network issues or the function endpoint being unavailable."):t.includes("AbortError")&&(s="Request aborted - edge function call was cancelled",n="The edge function request was aborted, possibly due to network issues or browser restrictions."),{connected:!1,error:s,details:n}}},[]),g=t.useCallback(async(e,t=1)=>{try{const s=new Promise((e,t)=>{setTimeout(()=>t(new Error("Edge Function request timed out - function may not be deployed or accessible")),15e3)}),n=r.functions.invoke("cars-sync",{body:e,headers:{"x-sync-attempt":t.toString(),"x-coordinator":"ai-powered"}}),{data:a,error:i}=await Promise.race([n,s]);if(i)throw i;return a}catch(s){const r=u(s);if(!r.recoverable||t>=n)throw s;if("abort"===r.action)throw s;const a=1e3*Math.random(),i=r.delayMs+1e3*t+a;return await new Promise(e=>setTimeout(e,i)),g(e,t+1)}},[n,u]),h=t.useCallback(async(e={})=>{if(!i){c(!0),l(0);try{const t=await m();if(!t.connected)throw new Error(`Edge Function not accessible: ${t.error||"Unknown connectivity issue"}`);const{data:s,error:n}=await r.from("sync_status").select("*").eq("id","cars-sync-main").single();let a={smartSync:!0,aiCoordinated:!0,source:"ai-coordinator",...e};"failed"===s?.status&&(a={...a,fromPage:s.current_page,reconcileProgress:!0,resumeFromFailure:"failed"===s.status}),await g(a),d({title:"🤖 AI Sync Coordinator Active",description:"Intelligent sync management enabled with bulletproof error handling"})}catch(t){const e=t&&"object"==typeof t&&"message"in t?String(t.message):"Unknown error occurred";let s=e,n="";e.includes("timed out")&&e.includes("function may not be deployed")||e.includes("Connection test timed out")||e.includes("Edge Function not accessible")&&(e.includes("Connection")||e.includes("timed out")||e.includes("Unknown connectivity")||e.includes("Network error")||e.includes("Request aborted")||e.match(/Edge Function not accessible:\s*$/)||e.includes("Unknown connectivity issue"))?(s="Edge Function not accessible - the cars-sync function may not be deployed to Supabase",n="Check the Supabase dashboard to ensure the cars-sync edge function is deployed and running. See EDGE_FUNCTION_DEPLOYMENT.md for detailed deployment instructions."):e.includes("Failed to send")?(s="Unable to connect to Edge Function - network or deployment issue",n="This could be a network connectivity issue or the edge function may not be deployed. Check your internet connection and Supabase function deployment."):e.includes("timeout")||e.includes("Test timed out")?(s="Edge Function call timed out - the function may not be properly deployed or configured",n="The function exists but is not responding within the expected time frame."):e.includes("Authentication")||e.includes("JWT")?(s="Authentication error - Edge Function may require JWT verification configuration",n="Check your Supabase API keys and authentication settings."):e.includes("Function not found")||e.includes("404")?(s="Edge Function not found - cars-sync function may not be deployed",n="Deploy the cars-sync function to your Supabase project. See EDGE_FUNCTION_DEPLOYMENT.md for step-by-step instructions."):e.includes("network")||e.includes("fetch failed")?(s="Network error - unable to connect to Edge Function. Please check your internet connection",n="Verify your network connection and try again."):e.includes("CORS")?(s="CORS error - Edge Function may have incorrect CORS configuration",n="Check the CORS settings in your edge function code."):e.includes("AbortError")&&(s="Request cancelled - Edge Function call was aborted",n="The request was cancelled, possibly due to browser restrictions or network issues."),d({title:"AI Coordinator Failed",description:`Failed to start intelligent sync: ${n?`${s}. ${n}`:s}`,variant:"destructive"})}finally{c(!1)}}},[i,g,m,d]);return t.useEffect(()=>{if(!e)return;const t=async()=>{try{const{data:e}=await r.from("sync_status").select("*").eq("id","cars-sync-main").single();if(!e)return;const t=Date.now()-new Date(e.last_activity_at||e.started_at).getTime();"running"===e.status&&t>3e5&&await h({resume:!0,fromPage:e.current_page,reconcileProgress:!0,autoHeal:!0}),"failed"===e.status&&t>12e4&&await h({resume:!0,fromPage:e.current_page,reconcileProgress:!0,autoResume:!0})}catch(e){}},s=setInterval(t,3e4);return t(),()=>{clearInterval(s)}},[e,h]),t.useEffect(()=>(e&&(window.aiSyncCoordinator={startIntelligentSync:h,invokeEdgeFunctionWithRetry:g,classifyErrorAndGetStrategy:u,testEdgeFunctionConnectivity:m}),()=>{const e=window;e.aiSyncCoordinator&&delete e.aiSyncCoordinator}),[e,h,g,u,m]),null};export{u as A,d as F,m as a};
