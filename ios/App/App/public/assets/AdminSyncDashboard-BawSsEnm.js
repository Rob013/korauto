import{j as e}from"./ui-5CGx59HE.js";import{r as s}from"./vendor-Ce2S7JN_.js";import{c as t,u as a,B as r,C as n,e as c,f as i,b as l,i as o}from"./index-DXJv48IP.js";import{R as d,P as m}from"./progress-esslBWV-.js";import{s as u}from"./client-ClhMjqWB.js";import{D as h,T as x}from"./trending-up-DmCHOUY3.js";import{Z as p}from"./zap-DZpTOGCU.js";import{A as g}from"./activity-BIG2I9ui.js";import{C as f}from"./clock-Bsx_Ypxj.js";import{C as y}from"./circle-alert-BSl6uMxW.js";import{C as j}from"./circle-check-big-CBL_LzJM.js";import"./supabase-FBsvvB2P.js";import"./utils-DN5cgeP9.js";import"./query-D7el4M-V.js";import"./router-CrtsEgIx.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const w=t("CircleStop",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["rect",{x:"9",y:"9",width:"6",height:"6",rx:"1",key:"1ssd4o"}]]);function b(){const{syncStatus:t,totalCount:b,triggerSync:N,getSyncStatus:v}=(()=>{const[e,t]=s.useState([]),[a,r]=s.useState(!1),[n,c]=s.useState(null),[i,l]=s.useState(null),[o,d]=s.useState(0),m=async(e=1,s=100,a)=>{r(!0),c(null);try{const s=[{id:"1",make:"BMW",model:"M3",year:2022,price:67300,mileage:25e3,image_url:"https://images.unsplash.com/photo-1555215695-3004980ad54e?w=800",source_api:"auctionapis",status:"active"},{id:"2",make:"Mercedes-Benz",model:"C-Class",year:2021,price:47300,mileage:3e4,image_url:"https://images.unsplash.com/photo-1563720223185-11003d516935?w=800",source_api:"auctionapis",status:"active"}];await new Promise(e=>setTimeout(e,500)),t(1===e?s:e=>[...e,...s]),d(s.length)}catch(n){c(n instanceof Error?n.message:"Failed to fetch cars")}finally{r(!1)}},h=async()=>{try{const{data:e,error:s}=await u.from("sync_status").select("*").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(s)throw s;l(e)}catch(e){}};return s.useEffect(()=>{const e=u.channel("sync-status-changes").on("postgres_changes",{event:"*",schema:"public",table:"sync_status"},e=>{e.new&&"object"==typeof e.new&&l(e.new)}).subscribe();return()=>{u.removeChannel(e)}},[]),s.useEffect(()=>{const e=u.channel("cars-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"cars"},e=>{if(e.new&&"object"==typeof e.new){const s=e.new;"auctionapis"===s.source_api&&(t(e=>[s,...e]),d(e=>e+1))}}).subscribe();return()=>{u.removeChannel(e)}},[]),s.useEffect(()=>{m(1,100),h();const s=u.channel("sync-status-realtime").on("postgres_changes",{event:"UPDATE",schema:"public",table:"sync_status"},e=>{e.new&&"object"==typeof e.new&&l(e.new)}).subscribe(),t=u.channel("cars-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"cars"},s=>{d(e=>e+1),e.length>0&&m(1,100)}).subscribe(),a=setInterval(async()=>{h();try{const[e,s]=await Promise.all([u.from("cars_cache").select("id",{count:"exact",head:!0}),u.from("cars").select("id",{count:"exact",head:!0})]),t=e.count||0,a=s.count||0;d(t>0?t:a)}catch(e){}},3e4);return()=>{u.removeChannel(s),u.removeChannel(t),clearInterval(a)}},[]),{cars:e,loading:a,error:n,syncStatus:i,totalCount:o,fetchCars:m,triggerSync:async(e="incremental")=>{r(!0),c(null);try{const{data:s,error:t}=await u.functions.invoke("cars-sync",{body:{type:e}});if(t){const e=t?.message||t?.details||String(t)||"Unknown error";throw e.includes("JWT")||e.includes("auth")?new Error("Authentication error - please refresh the page"):e.includes("timeout")||e.includes("timed out")?new Error("Request timeout - sync may still be running"):e.includes("500")||e.includes("Internal")?new Error("Server error - please try again"):new Error(e)}if(!s||"object"!=typeof s)throw new Error("Invalid response from sync function");if(s&&"object"==typeof s&&!1===s.success){const e=s.error||s.message||"Sync operation failed";throw new Error(String(e))}if(await h(),"running"===s.status){const s=setInterval(async()=>{await h();const t=await u.from("sync_status").select("status").order("created_at",{ascending:!1}).limit(1).maybeSingle();"completed"!==t.data?.status&&"failed"!==t.data?.status||(clearInterval(s),"incremental"===e&&m(1,100))},5e3);setTimeout(()=>clearInterval(s),6e5)}else"incremental"===e&&setTimeout(()=>m(1,100),1e3)}catch(s){let e="Failed to trigger sync";throw s&&"object"==typeof s?e="message"in s&&"string"==typeof s.message?s.message:"error"in s&&"string"==typeof s.error?s.error:"details"in s&&"string"==typeof s.details?s.details:String(s):"string"==typeof s&&(e=s),c(e),new Error(e)}finally{r(!1)}},getSyncStatus:h}})(),{toast:S}=a(),[_,C]=s.useState(!1),[I,T]=s.useState(!1),E=()=>{if(!t||!t.total_records||0===t.total_records)return 0;const e=t.records_processed||0;return Math.min(e/t.total_records*100,100)},k=()=>{if(!t||"running"!==t.status||!t.started_at)return null;const e=new Date(t.started_at).getTime(),s=(Date.now()-e)/6e4,a=t.records_processed||0,r=t.total_records||0;return 0===a||0===s?null:(r-a)/(a/s)},F=()=>{if(!t||"running"!==t.status||!t.started_at)return null;const e=new Date(t.started_at).getTime(),s=(Date.now()-e)/6e4,a=t.records_processed||0;return 0===a||0===s?null:Math.round(a/s)},M=e=>null===e||e<=0?"Calculating...":e<60?`${Math.round(e)}m`:`${Math.floor(e/60)}h ${Math.round(e%60)}m`;return e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold tracking-tight",children:"Sync Dashboard"}),e.jsxs(r,{variant:"outline",size:"sm",onClick:v,children:[e.jsx(d,{className:"h-3 w-3 sm:h-4 sm:w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]})]}),e.jsxs("div",{className:"grid gap-2 sm:gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",children:[e.jsxs(n,{children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(i,{className:"text-sm font-medium",children:"Sync Status"}),(s=>{switch(s){case"completed":return e.jsx(j,{className:"h-4 w-4 text-green-500"});case"running":return e.jsx(g,{className:"h-4 w-4 text-blue-500 animate-spin"});case"failed":return e.jsx(y,{className:"h-4 w-4 text-red-500"});default:return e.jsx(f,{className:"h-4 w-4 text-gray-500"})}})(t?.status)]}),e.jsxs(l,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t?.status?t.status.charAt(0).toUpperCase()+t.status.slice(1):"Unknown"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t?.sync_type?`${t.sync_type} sync`:"No active sync"})]})]}),e.jsxs(n,{children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(i,{className:"text-sm font-medium",children:"Progress"}),e.jsx(h,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(l,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[E().toFixed(1),"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(t?.records_processed||0).toLocaleString()," / ",(t?.total_records||0).toLocaleString()," records"]}),"running"===t?.status&&e.jsxs(e.Fragment,{children:[e.jsx(m,{value:E(),className:"mt-2"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsxs("span",{children:["Rate: ",F(),"/min"]}),e.jsxs("span",{children:["ETA: ",M(k())]})]})]})]})]}),e.jsxs(n,{children:[e.jsxs(c,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(i,{className:"text-sm font-medium",children:"Last Update"}),e.jsx(x,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(l,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t?.last_activity_at?new Date(t.last_activity_at).toLocaleTimeString():"Never"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t?.last_activity_at?`${Math.round((Date.now()-new Date(t.last_activity_at).getTime())/6e4)} min ago`:"No recent activity"})]})]})]}),e.jsxs(n,{children:[e.jsxs(c,{children:[e.jsxs(i,{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-5 w-5"}),"High-Performance Sync Controls"]}),e.jsx(o,{children:"Optimized sync operations for fast data synchronization (30-40 min target)"})]}),e.jsxs(l,{children:[e.jsxs("div",{className:"grid gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(r,{onClick:async()=>{try{const e=await fetch("https://qtyyiqimkysmjnaocswe.supabase.co/functions/v1/cars-sync",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0eXlpcWlta3lzbWpuYW9jc3dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MzkxMzQsImV4cCI6MjA2OTAxNTEzNH0.lyRCHiShhW4wrGHL3G7pK5JBUHNAtgSUQACVOBGRpL8"},body:JSON.stringify({syncType:"full",smartSync:!0,aiCoordinated:!0,source:"admin-dashboard"})}),s=await e.json();if(!s.success)throw new Error(s.message||"Failed to start full sync");S({title:"ðŸš€ Full Sync Started Successfully!",description:"Smart AI-coordinated full sync is now running. Check the status for progress updates."}),setTimeout(()=>v(),2e3)}catch(e){S({title:"Sync Failed",description:e instanceof Error?e.message:"Failed to start full sync",variant:"destructive"})}},disabled:"running"===t?.status,className:"w-full",children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),"Full Sync"]}),e.jsxs(r,{variant:"outline",onClick:async()=>{C(!0);try{await N("incremental"),S({title:"ðŸ”„ Real API Incremental Sync Started",description:"Fetching recent real car updates from live API."})}catch(e){S({title:"Sync Failed",description:e instanceof Error?e.message:"Failed to start sync",variant:"destructive"})}finally{C(!1)}},disabled:_||"running"===t?.status,className:"w-full",children:[e.jsx(g,{className:"h-4 w-4 mr-2"}),_?"Syncing...":"Incremental Sync"]}),e.jsxs(r,{variant:"outline",onClick:async()=>{try{const e=await fetch("https://qtyyiqimkysmjnaocswe.supabase.co/functions/v1/cars-sync?seed=true",{method:"POST",headers:{"Content-Type":"application/json"}}),s=await e.json();if(!s.success)throw new Error(s.message||"Failed to seed data");S({title:"Sample data added",description:`Successfully added ${s.cars_added} sample cars to the database.`}),v()}catch(e){S({title:"Error",description:e instanceof Error?e.message:"Failed to seed sample data",variant:"destructive"})}},disabled:"running"===t?.status,className:"w-full",children:[e.jsx(h,{className:"h-4 w-4 mr-2"}),"Sample Data"]}),"running"===t?.status&&e.jsxs(r,{variant:"destructive",onClick:async()=>{try{const{error:e}=await u.from("sync_status").update({status:"failed",completed_at:(new Date).toISOString(),error_message:"Manually stopped by admin"}).eq("status","running");if(e)throw e;S({title:"ðŸ›‘ Sync Stopped",description:"All running syncs have been stopped"}),v()}catch(e){S({title:"Error",description:"Failed to stop running syncs",variant:"destructive"})}},className:"w-full",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),"Stop Sync"]})]}),"running"===t?.status&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(g,{className:"h-4 w-4 text-blue-600 animate-spin"}),e.jsx("span",{className:"font-medium text-blue-900",children:"High-Performance Sync Active"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Current Page:"}),e.jsx("span",{className:"font-mono ml-2",children:t.current_page||0})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Estimated Total:"}),e.jsx("span",{className:"font-mono ml-2",children:t.total_pages||"Calculating..."})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Processing Rate:"}),e.jsxs("span",{className:"font-mono ml-2",children:[F()||0," records/min"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Time Remaining:"}),e.jsx("span",{className:"font-mono ml-2",children:M(k())})]})]})]})]})]}),e.jsxs(n,{children:[e.jsx(c,{children:e.jsxs(i,{className:"flex items-center gap-2",children:[e.jsx(x,{className:"h-5 w-5"}),"Performance Summary"]})}),e.jsx(l,{children:e.jsxs("div",{className:"grid gap-4 grid-cols-1 sm:grid-cols-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:(b||0).toLocaleString()}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Cars Available"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[t?.records_processed?Math.round(t.records_processed/(b||1)*100):0,"%"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Database Coverage"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:t?.last_activity_at?Math.round((Date.now()-new Date(t.last_activity_at).getTime())/6e4):"N/A"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Minutes Since Last Update"})]})]})})]})]})}export{b as default};
