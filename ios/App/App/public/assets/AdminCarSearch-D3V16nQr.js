import{j as e}from"./ui-5CGx59HE.js";import{r as a}from"./vendor-Ce2S7JN_.js";import{I as s}from"./input-BjLg3enW.js";import{c as r,u as t,C as i,e as o,f as l,b as n,B as c,X as d}from"./index-DXJv48IP.js";import{B as m}from"./badge-CtAh7DWu.js";import{s as u}from"./client-ClhMjqWB.js";import{u as h}from"./useCurrencyAPI-4V5PeEfF.js";import{S as p}from"./search-b9WDS7dH.js";import{L as x}from"./loader-circle-Cz5GAv8d.js";import{C as f}from"./car-BxrBaIAr.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const g=r("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]),v=({className:r=""})=>{const[v,j]=a.useState(""),[y,b]=a.useState([]),[N,_]=a.useState(!1),[k,w]=a.useState(!1),{toast:$}=t(),{convertUSDtoEUR:C}=h(),S=a.useRef(),I=a.useRef(null),L=a.useCallback(async e=>{if(!e.trim())return b([]),void w(!1);if(!(e.length<3)){_(!0),w(!0);try{const s=[],r=[u.from("cars_cache").select("api_id, make, model, year, vin, lot_number, car_data, price, mileage, color, fuel, transmission").or(`api_id.eq.${e},lot_number.eq.${e},vin.eq.${e}`).limit(5),u.from("cars_cache").select("api_id, make, model, year, vin, lot_number, car_data, price, mileage, color, fuel, transmission").or(`api_id.ilike.%${e}%,vin.ilike.%${e}%,lot_number.ilike.%${e}%`).limit(8),...e.length>=4?[u.from("cars_cache").select("api_id, make, model, year, vin, lot_number, car_data, price, mileage, color, fuel, transmission").or(`make.ilike.%${e}%,model.ilike.%${e}%`).limit(5)]:[]],t=await Promise.all(r),i=[];if(t.forEach(({data:e,error:a})=>{!a&&e&&e.length>0&&e.forEach(e=>{if(!i.some(a=>a.api_id===e.api_id)){const a={...e,car_data:e.car_data};i.push(a)}})}),i&&i.length>0){const e=i.map(e=>{const a=e.car_data,s=a?.lots?.[0];return{id:e.api_id,year:e.year,make:e.make,model:e.model,vin:e.vin,lot_number:e.lot_number||s?.lot,price:e.price||(s?.buy_now?C(Math.round(s.buy_now+2200)):void 0),image:s?.images?.normal?.[0]||s?.images?.big?.[0],mileage:e.mileage||(s?.odometer?.km?`${s.odometer.km.toLocaleString()} km`:void 0),fuel:e.fuel||a?.fuel?.name,transmission:e.transmission||a?.transmission?.name,color:e.color||a?.color?.name,source:"cached"}});s.push(...e)}const o=[{method:"Car ID",payload:{endpoint:"cars",carId:e}},{method:"Lot Number (IAAI)",payload:{endpoint:"search-lot",lotNumber:e}},{method:"General Search",payload:{endpoint:"cars",filters:{search:e,per_page:"10"}}},{method:"VIN Search",payload:{endpoint:"cars",filters:{vin:e,per_page:"10"}}},{method:"Enhanced Lot Search",payload:{endpoint:"cars",filters:{lot_number:e,per_page:"10"}}}];let l=!1;for(const e of o)try{const a=await u.functions.invoke("secure-cars-api",{body:e.payload});if(!a.error&&a.data){let e=[],r=null;a.data.data&&Array.isArray(a.data.data)?r=a.data.data:a.data.lots&&a.data.lots.length>0?r=[a.data]:Array.isArray(a.data)?r=a.data:(a.data.id||a.data.year)&&(r=[a.data]),r&&Array.isArray(r)&&(l=!0,e=r.map(e=>{const a=e.lots?.[0];return{id:e.id||e.api_id,year:e.year,make:e.manufacturer?.name||e.make||"Unknown",model:e.model?.name||e.model||"Unknown",vin:e.vin,lot_number:e.lot_number||a?.lot,price:a?.buy_now?C(Math.round(a.buy_now+2200)):void 0,image:a?.images?.normal?.[0]||a?.images?.big?.[0],mileage:a?.odometer?.km?`${a.odometer.km.toLocaleString()} km`:void 0,fuel:e.fuel?.name,transmission:e.transmission?.name,color:e.color?.name,source:"api"}}),e.forEach(e=>{s.some(a=>a.id===e.id)||s.push(e)}))}}catch(a){}!l&&s.length;const n=s.filter((e,a,s)=>a===s.findIndex(a=>a.id===e.id)).sort((a,s)=>{const r=e.toLowerCase(),t=a.id.toLowerCase()===r,i=s.id.toLowerCase()===r,o=a.lot_number?.toLowerCase()===r,l=s.lot_number?.toLowerCase()===r;return t&&!i?-1:!t&&i?1:o&&!l?-1:!o&&l?1:0});if(b(n.slice(0,10)),0===n.length)$({title:"No results found",description:`No cars found matching "${e}". Searched ${i.length>0?"cached database and ":""}live APIs across multiple auction sources.`,variant:"default"});else{const e=n.reduce((e,a)=>(e[a.source]=(e[a.source]||0)+1,e),{}),a=Object.entries(e).map(([e,a])=>`${a} from ${"cached"===e?"database":"live API"}`).join(", ");$({title:"Search completed successfully",description:`Found ${n.length} car${1!==n.length?"s":""}: ${a}`,variant:"default"})}}catch(s){$({title:"Search Error",description:"Failed to search for cars. Please try again.",variant:"destructive"})}finally{_(!1)}}},[$]),A=a.useCallback(e=>{j(e),S.current&&clearTimeout(S.current),e.trim()?S.current=setTimeout(()=>{L(e)},500):(b([]),w(!1))},[L]),E=a.useCallback(()=>{j(""),b([]),w(!1),S.current&&clearTimeout(S.current),I.current?.focus()},[]),P=a.useCallback(e=>{const a=`/car/${e}`;window.open(a,"_blank"),$({title:"Opening car details",description:`Opening car details for ID: ${e}`})},[$]);return a.useEffect(()=>()=>{S.current&&clearTimeout(S.current)},[]),e.jsx("div",{className:`relative ${r}`,children:e.jsxs(i,{className:"border-2 border-primary/20",children:[e.jsx(o,{className:"pb-3",children:e.jsxs(l,{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(p,{className:"h-5 w-5 text-primary"}),"Enhanced Car Search"]})}),e.jsxs(n,{className:"pt-0",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(s,{ref:I,type:"text",placeholder:"Search by Car ID, Lot Number, VIN... (enhanced search: exact matches first, then partial)",value:v,onChange:e=>A(e.target.value),className:"pr-10"}),v&&e.jsx(c,{variant:"ghost",size:"sm",onClick:E,className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6 p-0 hover:bg-muted",children:e.jsx(d,{className:"h-3 w-3"})})]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>L(v),disabled:N||!v.trim(),className:"flex items-center gap-1",children:[N?e.jsx(x,{className:"h-4 w-4 animate-spin"}):e.jsx(p,{className:"h-4 w-4"}),"Search"]})]}),k&&e.jsx("div",{className:"mt-4",children:N?e.jsxs("div",{className:"flex items-center justify-center py-8 text-muted-foreground",children:[e.jsx(x,{className:"h-5 w-5 animate-spin mr-2"}),"Searching..."]}):y.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Found ",y.length," result",1!==y.length?"s":""]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:y.map(a=>e.jsx("div",{className:"group relative p-3 rounded-lg border border-border/50 hover:border-primary/30 hover:shadow-sm transition-all duration-200 bg-card/50 hover:bg-card cursor-pointer",onClick:()=>P(a.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"shrink-0 w-16 h-12 rounded-md overflow-hidden bg-muted flex items-center justify-center",children:a.image?e.jsx("img",{src:a.image,alt:`${a.year} ${a.make} ${a.model}`,className:"w-full h-full object-cover"}):e.jsx(f,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("h4",{className:"font-medium text-sm text-foreground truncate",children:[a.year," ",a.make," ",a.model]}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-1",children:[e.jsxs(m,{variant:"outline",className:"text-xs",children:["ID: ",a.id]}),a.lot_number&&e.jsxs(m,{variant:"outline",className:"text-xs",children:["Lot: ",a.lot_number]}),a.vin&&e.jsxs(m,{variant:"outline",className:"text-xs",children:["VIN: ",a.vin.slice(-6)]}),e.jsx(m,{variant:"cached"===a.source?"default":"secondary",className:"text-xs",children:"cached"===a.source?"üíæ Cached":"üåê Live API"})]})]}),e.jsx(g,{className:"h-4 w-4 text-muted-foreground group-hover:text-primary transition-colors"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[a.price&&e.jsxs("div",{children:["Price: ‚Ç¨",a.price.toLocaleString()]}),e.jsxs("div",{className:"flex gap-4",children:[a.mileage&&e.jsxs("span",{children:["üìè ",a.mileage]}),a.fuel&&e.jsxs("span",{children:["‚õΩ ",a.fuel]}),a.transmission&&e.jsxs("span",{children:["‚öôÔ∏è ",a.transmission]}),a.color&&e.jsxs("span",{children:["üé® ",a.color]})]})]})]})]})},a.id))})]}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(p,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsxs("p",{className:"text-sm",children:['No cars found matching "',v,'"']}),e.jsx("p",{className:"text-xs mt-1",children:"Comprehensive search across cached database and live APIs"})]})})]})]})})};export{v as A};
